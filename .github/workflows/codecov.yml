name: "Code Coverage"

on:
  workflow_call:
    secrets:
      CODECOV_TOKEN:
          required: true
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - uses: actions/setup-go@v5
      with:
          go-version: '1.21'
          check-latest: true
    - name: Optional init
      run: make dependencies || true # Used in fortio for instance to prep for go tests
    - name: Run test coverage
      run: go test -coverprofile=coverage.out ./...
    - uses: codecov/codecov-action@v4
      with:
        files: coverage.out
        token: ${{ secrets.CODECOV_TOKEN }}
